<!-- Template Version: {{ template_version }} - Force Update v3 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Mob Control Players</title>
    <style>
        body {
            background-color: #1a1d2e;
            color: #e0e0e0;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
        }
        .current-user-row {
            background-color: rgba(110, 193, 228, 0.15) !important;
            border: 2px solid #6ec1e4 !important;
            box-shadow: 0 0 10px rgba(110, 193, 228, 0.3) !important;
        }

        .toggle-theme {
            cursor: pointer;
            font-size: 20px;
            color: #6ec1e4;
            margin-left: 15px;
            transition: transform 0.2s;
        }
        
        .toggle-theme:hover {
            transform: scale(1.1);
        }
        
        body.light-mode {
            background-color: #f4f4f4;
            color: #000;
        }
        
        .light-mode .toggle-theme {
            color: #00695c;
        }
        
        header {
            background-color: #272b3f;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(150, 200, 255, 0.15);
        }
        
        .light-mode header {
            background-color: #ffffff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* Special admin header styling */
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border: 2px solid #ffd700;
            position: relative;
            overflow: hidden;
        }
        
        .admin-header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            animation: shimmer 3s infinite;
            pointer-events: none;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .admin-title {
            color: #ffd700 !important;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            position: relative;
            z-index: 1;
        }
        
        .admin-title::before {
            content: "üëë ";
            animation: bounce 2s infinite;
        }
        
        .admin-title::after {
            content: " üëë";
            animation: bounce 2s infinite 0.5s;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
        
        h1 {
            margin: 0;
            font-size: 1.5rem;
            color: #9ecbff;
        }
        
        .light-mode h1 {
            color: #00695c;
        }
        
        .actions a, .actions form {
            display: inline-block;
            margin-right: 10px;
        }
        
        .logout-btn, .edit-btn, .delete-btn {
            background-color: #e53935;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .edit-btn {
            background-color: #6ec1e4;
        }
        
        .edit-btn:hover {
            background-color: #5ab0d6;
        }
        
        .logout-btn:hover, .delete-btn:hover {
            background-color: #d32f2f;
        }
        
        /* Special admin buttons */
        .admin-edit-btn {
            background: linear-gradient(135deg, #ffd700, #ffed4e) !important;
            color: #000 !important;
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            text-shadow: none !important;
        }
        
        .admin-edit-btn:hover {
            background: linear-gradient(135deg, #ffed4e, #fff176) !important;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.6);
        }
        
        .admin-logout-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52) !important;
            border: 2px solid #ff5252;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.4);
        }
        
        .admin-logout-btn:hover {
            background: linear-gradient(135deg, #ff5252, #e53935) !important;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.6);
        }
        
        .ping-btn {
            background-color: #00c853;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .ping-btn:hover {
            background-color: #00a847;
        }
        
        .admin-profile-row {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7) !important;
            background-size: 300% 300% !important;
            animation: adminGradient 3s ease infinite !important;
            border: 3px solid #ffd700 !important;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.7) !important;
            position: relative;
            z-index: 2;
        }
        
        .admin-profile-row::before {
            content: "üëë SUPREME ADMIN üëë";
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            padding: 4px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 3px 15px rgba(255, 215, 0, 0.5);
            z-index: 10;
            border: 2px solid #fff;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 3px 15px rgba(255, 215, 0, 0.5); }
            to { box-shadow: 0 6px 25px rgba(255, 215, 0, 0.9); }
        }
        
        .admin-profile-row td {
            color: #000 !important;
            font-weight: bold !important;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8) !important;
            font-size: 1.1em !important;
        }
        
        .light-mode .admin-profile-row td {
            color: #000 !important;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8) !important;
        }
        
        @keyframes adminGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .admin-controls {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            border: 3px solid #ffd700;
            position: relative;
            overflow: hidden;
        }
        
        .admin-controls::before {
            content: "";
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ffd700, #ff6b6b, #4ecdc4, #ffd700);
            background-size: 200% 200%;
            animation: borderGlow 3s linear infinite;
            border-radius: 15px;
            z-index: -1;
        }
        
        @keyframes borderGlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        
        .admin-controls h2 {
            margin: 0 0 15px 0;
            font-size: 1.4rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: pulse 2s ease-in-out infinite alternate;
        }
        
        .admin-controls p {
            margin: 0;
            font-size: 1rem;
            opacity: 0.95;
            font-weight: 500;
        }
        
        @keyframes pulse {
            from { text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
            to { text-shadow: 2px 2px 8px rgba(255,215,0,0.6); }
        }
        
        .super-delete-btn {
            background: linear-gradient(135deg, #ff4757, #c44569) !important;
            color: white !important;
            border: 2px solid #ff3838 !important;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4) !important;
            animation: deleteButtonPulse 2s infinite !important;
        }
        
        .super-delete-btn:hover {
            background: linear-gradient(135deg, #ff3838, #b83759) !important;
            transform: scale(1.05) !important;
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.6) !important;
        }
        
        @keyframes deleteButtonPulse {
            0% { box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(255, 71, 87, 0.7); }
            100% { box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4); }
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #272b3f;
            margin: 20px 0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(150, 200, 255, 0.15);
        }
        
        .light-mode table {
            background-color: #ffffff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            border-bottom: 1px solid rgba(150, 200, 255, 0.1);
            text-align: center;
        }
        
        .light-mode th, .light-mode td {
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        th {
            background-color: #202437;
            color: #9ecbff;
            font-weight: bold;
        }
        
        .light-mode th {
            background-color: #f0f0f0;
            color: #00695c;
        }
        
        tr:hover {
            background-color: rgba(150, 200, 255, 0.05);
        }
        
        .light-mode tr:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        .search-container {
            display: flex;
            gap: 15px;
            margin: 20px;
            padding: 20px;
            background-color: #272b3f;
            border-radius: 15px;
            box-shadow: 0 0 15px rgba(150, 200, 255, 0.15);
            flex-wrap: wrap;
            position: relative;
        }
        
        .light-mode .search-container {
            background-color: #ffffff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .search-box {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .search-box label {
            font-size: 0.9rem;
            color: #9ecbff;
            font-weight: bold;
        }
        
        .light-mode .search-box label {
            color: #00695c;
        }
        
        .search-box input[type="text"], .search-box select {
            padding: 10px;
            width: 200px;
            background-color: #202437;
            border: none;
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
        }
        
        .light-mode .search-box input[type="text"], 
        .light-mode .search-box select {
            background-color: #f0f0f0;
            color: #000;
        }
        
        .actions-cell {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Cute Notification Icon Styles */
        .notification-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            animation: gentleFloat 3s ease-in-out infinite;
            transition: all 0.3s ease;
            z-index: 5;
        }

        .light-mode .notification-icon {
            background: linear-gradient(135deg, #ff5722, #d84315);
            box-shadow: 0 4px 15px rgba(255, 87, 34, 0.4);
        }

        .notification-icon:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 25px rgba(255, 107, 107, 0.6);
        }

        .light-mode .notification-icon:hover {
            box-shadow: 0 6px 25px rgba(255, 87, 34, 0.6);
        }

        .notification-icon .icon {
            font-size: 22px;
            animation: ping-pulse 2s ease-in-out infinite;
        }

        .notification-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ffd700;
            color: #000;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            animation: bounce-count 1s ease-in-out infinite alternate;
        }

        @keyframes gentleFloat {
            0%, 100% { transform: translateY(-50%); }
            50% { transform: translateY(-55%); }
        }

        @keyframes ping-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes bounce-count {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        /* Notification Popup Styles */
        .notification-popup {
            position: absolute;
            right: 20px;
            top: -350px;
            width: 350px;
            max-height: 400px;
            background: #272b3f;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .light-mode .notification-popup {
            background: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .notification-popup.show {
            opacity: 1;
            transform: translateY(0);
        }

        .popup-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            position: relative;
        }

        .light-mode .popup-header {
            background: linear-gradient(135deg, #ff5722, #d84315);
        }

        .popup-close {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .clear-all-btn {
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            background: #ff4757;
            border: none;
            color: white;
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.2s;
        }

        .clear-all-btn:hover {
            opacity: 1;
            background: #ff3838;
        }

        .popup-close:hover {
            opacity: 1;
        }

        .notification-list {
            max-height: 320px;
            overflow-y: auto;
            padding: 10px;
        }

        .notification-item {
            background: rgba(110, 193, 228, 0.1);
            border: 1px solid rgba(110, 193, 228, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .light-mode .notification-item {
            background: rgba(0, 105, 92, 0.05);
            border: 1px solid rgba(0, 105, 92, 0.1);
        }

        .notification-item:hover {
            background: rgba(110, 193, 228, 0.2);
            transform: translateX(5px);
        }

        .light-mode .notification-item:hover {
            background: rgba(0, 105, 92, 0.1);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .ping-sender {
            font-weight: bold;
            color: #6ec1e4;
        }

        .light-mode .ping-sender {
            color: #00695c;
        }

        .ping-time {
            font-size: 11px;
            opacity: 0.7;
        }

        .ping-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            opacity: 0.9;
        }

        .ping-back-btn {
            background: #00c853;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .ping-back-btn:hover {
            background: #00a847;
        }

        .no-notifications {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.6;
            font-style: italic;
        }

        @media screen and (max-width: 768px) {
            .search-container {
                flex-direction: column;
                margin: 10px;
                padding: 15px;
            }
            
            .notification-icon {
                right: 10px;
                width: 45px;
                height: 45px;
            }

            .notification-popup {
                right: 10px;
                width: calc(100vw - 20px);
                max-width: 300px;
            }
            
            .search-box input[type="text"], .search-box select {
                width: 100%;
            }
            
            header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .header-left {
                flex-direction: column;
                gap: 10px;
            }
            
            .actions {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                justify-content: center;
            }
            
            table {
                font-size: 12px;
            }
            
            .actions-cell {
                flex-direction: column;
                gap: 5px;
            }
            
            .toggle-theme {
                margin-left: 0;
                font-size: 22px;
            }
        }
    </style>
</head>
<body>

<header id="main-header">
    <div class="header-left">
        <h1 id="main-title">Mob Control Global Player List</h1>
        <div class="toggle-theme" id="theme-toggle">üåô</div>
    </div>
    <div class="actions">
        <!-- Debug info - Remove this in production -->
        {% if session.get('user_id') %}
            <span style="color: #ffd700; font-size: 10px; margin-right: 10px;">
                DEBUG: ID={{ session.get('user_id') }}, Role={{ session.get('role') }}
            </span>
        {% endif %}
        
        {% if session.get('user_id') %}
            <a href="{{ url_for('edit_profile') }}" class="edit-btn {% if session.get('role') == 'admin' %}admin-edit-btn{% endif %}">
                {% if session.get('role') == 'admin' %}üëë My Profile{% else %}My Profile{% endif %}
            </a>
            <form action="{{ url_for('delete_player', player_id=session.get('user_id')) }}" method="POST" onsubmit="return confirm('This will permanently delete your profile. Continue?');" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="delete-btn {% if session.get('role') == 'admin' %}super-delete-btn{% endif %}">
                    {% if session.get('role') == 'admin' %}üíÄ Delete My Profile{% else %}Delete My Profile{% endif %}
                </button>
            </form>
            <!-- This logout button should ALWAYS show if user_id exists -->
            <a href="{{ url_for('logout') }}" class="logout-btn {% if session.get('role') == 'admin' %}admin-logout-btn{% endif %}" style="display: inline-block !important;">
                {% if session.get('role') == 'admin' %}üö™ Admin Logout{% else %}Logout{% endif %}
            </a>
        {% else %}
            <a href="{{ url_for('login') }}" class="edit-btn">Login</a>
            <a href="{{ url_for('register') }}" class="edit-btn">Register</a>
        {% endif %}
</div>
</header>

{% if session.get('role') == 'admin' %}
<div class="admin-controls">
    <h2>üõ°Ô∏è SUPREME ADMIN CONTROL PANEL üõ°Ô∏è</h2>
    <p>You have ultimate authority over the realm - You can delete any player profile including your own!</p>
</div>
{% endif %}

<div class="search-container">
    <div class="search-box">
        <label for="nameSearch">Search by Username:</label>
        <input type="text" id="nameSearch" placeholder="Enter username">
    </div>
    <div class="search-box">
        <label for="countryFilter">Filter by Region:</label>
        <select id="countryFilter">
            <option value="">All Regions</option>
            {% for country in countries %}
                <option value="{{ country }}">{{ country }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="search-box">
        <label for="tierFilter">Filter by Tier:</label>
        <select id="tierFilter">
            <option value="">All Tiers</option>
            {% for tier in tiers %}
                <option>{{ tier }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Cute Notification Icon - Always visible for logged-in users -->
    {% if session.get('user_id') %}
    <div class="notification-icon" id="notificationIcon">
        <span class="icon">üì°</span>
        <div class="notification-count" id="notificationCount" {% if not user_pings or user_pings|length == 0 %}style="display: none;"{% endif %}>
            {{ user_pings|length if user_pings else 0 }}
        </div>
    </div>

    <!-- Notification Popup -->
    <div class="notification-popup" id="notificationPopup">
        <div class="popup-header">
            üì° Ping Notifications
            <button class="popup-close" id="popupClose">√ó</button>
            {% if user_pings and user_pings|length > 0 %}
            <button class="clear-all-btn" id="clearAllBtn">üóëÔ∏è</button>
            {% endif %}
        </div>
        <div class="notification-list" id="notificationList">
            {% if user_pings and user_pings|length > 0 %}
                {% for ping in user_pings %}
                <div class="notification-item" data-ping-id="{{ ping.id }}">
                    <div class="notification-header">
                        <span class="ping-sender">{{ ping.username }}</span>
                        <span class="ping-time">{{ ping.timestamp.strftime('%H:%M') if ping.timestamp else 'Now' }}</span>
                    </div>
                    <div class="ping-info">
                        <div>
                            <div>üåç {{ ping.country }}</div>
                            <div>‚è∞ {{ ping.local_time }}</div>
                            <div>üèÜ {{ ping.tier }}</div>
                        </div>
                        <button class="ping-back-btn" data-ping-id="{{ ping.id }}" data-sender-id="{{ ping.sender_id if ping.sender_id else '' }}">
                            Ping Back
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-notifications" id="noNotifications">
                    No ping notifications yet! üåü
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<div style="margin: 0 20px;">
    <table>
        <thead>
            <tr>
                <th>In-Game Name</th>
                <th>Region</th>
                <th>Tier</th>
                <th>Local Time</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="playerTable">
            {% for player in players %}
            <tr {% if (session.get('role') == 'admin' and player['id'] == session.get('user_id')) or (session.get('role') == 'admin' and player['username'] == 'omfgryu') or player.get('is_admin') %}class="admin-profile-row"{% elif player['id'] == session.get('user_id') %}class="current-user-row"{% endif %}>
                <td>
                    {% if (session.get('role') == 'admin' and player['id'] == session.get('user_id')) or (session.get('role') == 'admin' and player['username'] == 'omfgryu') or player.get('is_admin') %}
                        üëë {{ player['username'] }} üëë
                    {% else %}
                        {{ player['username'] }}
                    {% endif %}
                </td>
                <td>{{ player['country'] }}</td>
                <td>{{ player['tier'] }}</td>
                <td class="local-time" data-country="{{ player['country'] }}">
                    {{ player['local_time'] if player['local_time'] != 'N/A' else 'Calculating...' }}
                </td>
                <td class="actions-cell">
                    {% if session.get('user_id') == player['id'] %}
                        <a href="{{ url_for('edit_profile') }}" class="edit-btn {% if session.get('role') == 'admin' %}admin-edit-btn{% endif %}">
                            {% if session.get('role') == 'admin' %}üëë Edit{% else %}Edit{% endif %}
                        </a>
                        <form action="{{ url_for('delete_player', player_id=player['id']) }}" method="POST" onsubmit="return confirm('‚ö†Ô∏è WARNING ‚ö†Ô∏è\n\nThis will permanently delete your profile and log you out!\n\nAre you sure you want to continue?\n\nClick OK to DELETE or Cancel to keep your profile.');" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>    
                            <button type="submit" class="delete-btn {% if session.get('role') == 'admin' %}super-delete-btn{% endif %}">
                                {% if session.get('role') == 'admin' %}üíÄ Delete{% else %}Delete{% endif %}
                            </button>
                        </form>
                    {% elif session.get('role') == 'admin' %}
                        <form action="{{ url_for('admin_delete_profile', player_id=player['id']) }}" method="POST" onsubmit="return confirm('‚ö†Ô∏è ADMIN ACTION ‚ö†Ô∏è\n\nAre you sure you want to permanently delete {{ player['username'] }}?\n\nThis action cannot be undone!');" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>    
                            <button type="submit" class="delete-btn super-delete-btn">üóëÔ∏è Admin Delete</button>
                        </form>
                    {% endif %}
                    
                    <!-- Only show ping button for OTHER users, not yourself -->
                    {% if session.get('user_id') != player['id'] %}
                        <button class="ping-btn" data-player-id="{{ player['id'] }}">Ping</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    // CSRF Token - MUST be at the top
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Function to make POST requests with CSRF token
    function postWithCSRF(url, data = {}) {
        return fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        });
    }

    // Current user ID for comparison
    const currentUserId = {{ session.get('user_id') if session.get('user_id') else 'null' }};
    
    // Check if user is admin and apply special styling
    const isAdmin = {{ 'true' if session.get('role') == 'admin' else 'false' }};
    
    if (isAdmin) {
        // Apply admin header styling
        const header = document.getElementById('main-header');
        const title = document.getElementById('main-title');
        
        header.classList.add('admin-header');
        title.classList.add('admin-title');
    }

    // Theme toggle functionality
    const toggle = document.getElementById('theme-toggle');
    toggle.addEventListener('click', () => {
        document.body.classList.toggle('light-mode');
        toggle.innerText = document.body.classList.contains('light-mode') ? '‚òÄÔ∏è' : 'üåô';
    });

    // Table filtering
    document.getElementById('nameSearch').addEventListener('input', filterTable);
    document.getElementById('countryFilter').addEventListener('change', filterTable);
    document.getElementById('tierFilter').addEventListener('change', filterTable);

    function filterTable() {
        const nameValue = document.getElementById('nameSearch').value.toLowerCase();
        const countryValue = document.getElementById('countryFilter').value;
        const tierValue = document.getElementById('tierFilter').value;
        const rows = document.querySelectorAll('#playerTable tr');

        rows.forEach(row => {
            const name = row.cells[0].textContent.toLowerCase();
            const country = row.cells[1].textContent;
            const tier = row.cells[2].textContent;

            const matchesName = name.includes(nameValue);
            const matchesCountry = countryValue === '' || country === countryValue;
            const matchesTier = tierValue === '' || tier === tierValue;

            row.style.display = matchesName && matchesCountry && matchesTier ? '' : 'none';
        });
    }

    // Notification Popup functionality
    const notificationIcon = document.getElementById('notificationIcon');
    const notificationPopup = document.getElementById('notificationPopup');
    const popupClose = document.getElementById('popupClose');

    if (notificationIcon && notificationPopup) {
        notificationIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            notificationPopup.classList.toggle('show');
        });

        if (popupClose) {
            popupClose.addEventListener('click', (e) => {
                e.stopPropagation();
                notificationPopup.classList.remove('show');
            });
        }

        // Close popup when clicking outside
        document.addEventListener('click', (e) => {
            if (!notificationPopup.contains(e.target) && !notificationIcon.contains(e.target)) {
                notificationPopup.classList.remove('show');
            }
        });

        // Ping back functionality
        const pingBackButtons = document.querySelectorAll('.ping-back-btn');
        pingBackButtons.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const pingId = this.dataset.pingId;
                const senderId = this.dataset.senderId;
                
                if (senderId) {
                    // Ping back the sender
                    postWithCSRF(`/ping/${senderId}`)
                        .then(response => {
                            if (response.ok) {
                                this.textContent = 'Sent!';
                                this.style.background = '#4caf50';
                                setTimeout(() => {
                                    this.textContent = 'Ping Back';
                                    this.style.background = '#00c853';
                                }, 2000);
                            } else {
                                this.textContent = 'Error';
                                this.style.background = '#f44336';
                                setTimeout(() => {
                                    this.textContent = 'Ping Back';
                                    this.style.background = '#00c853';
                                }, 2000);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            this.textContent = 'Failed';
                            this.style.background = '#f44336';
                            setTimeout(() => {
                                this.textContent = 'Ping Back';
                                this.style.background = '#00c853';
                            }, 2000);
                        });
                }
                
                // Mark notification as read and remove it
                if (pingId) {
                    postWithCSRF(`/mark_ping_read/${pingId}`)
                        .then(response => {
                            if (response.ok) {
                                // Remove this notification item completely
                                const notificationItem = this.closest('.notification-item');
                                notificationItem.style.opacity = '0';
                                notificationItem.style.transform = 'translateX(-100%)';
                                
                                setTimeout(() => {
                                    notificationItem.remove();
                                    updateNotificationCount();
                                    checkIfEmpty();
                                }, 300);
                            }
                        })
                        .catch(error => {
                            console.error('Error marking as read:', error);
                        });
                }
            });
        });

        // Clear all notifications functionality
        const clearAllBtn = document.getElementById('clearAllBtn');
        if (clearAllBtn) {
            clearAllBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (confirm('Clear all ping notifications?')) {
                    const notificationItems = document.querySelectorAll('.notification-item');
                    const pingIds = Array.from(notificationItems).map(item => item.dataset.pingId);
                    
                    // Mark all as read
                    Promise.all(pingIds.map(pingId => 
                        postWithCSRF(`/mark_ping_read/${pingId}`)
                    )).then(() => {
                        // Remove all notification items
                        notificationItems.forEach(item => {
                            item.style.opacity = '0';
                            item.style.transform = 'translateX(-100%)';
                        });
                        
                        setTimeout(() => {
                            notificationItems.forEach(item => item.remove());
                            updateNotificationCount();
                            checkIfEmpty();
                            clearAllBtn.style.display = 'none';
                        }, 300);
                    });
                }
            });
        }

        // Function to update notification count
        function updateNotificationCount() {
            const notificationCount = document.getElementById('notificationCount');
            const remainingNotifications = document.querySelectorAll('.notification-item').length;
            
            if (remainingNotifications === 0) {
                notificationCount.style.display = 'none';
            } else {
                notificationCount.style.display = 'flex';
                notificationCount.textContent = remainingNotifications;
            }
        }

        // Function to check if notifications are empty and show message
        function checkIfEmpty() {
            const notificationList = document.getElementById('notificationList');
            const remainingNotifications = document.querySelectorAll('.notification-item').length;
            
            if (remainingNotifications === 0) {
                const noNotifications = document.createElement('div');
                noNotifications.className = 'no-notifications';
                noNotifications.id = 'noNotifications';
                noNotifications.textContent = 'No ping notifications yet! üåü';
                notificationList.appendChild(noNotifications);
                
                // Hide clear all button
                const clearAllBtn = document.getElementById('clearAllBtn');
                if (clearAllBtn) clearAllBtn.style.display = 'none';
            }
        }
    }

    // MAIN PING FUNCTIONALITY - Regular ping buttons in the table
    document.querySelectorAll('.ping-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const playerId = parseInt(this.dataset.playerId);
            
            // Double check - don't let users ping themselves
            if (currentUserId && playerId === currentUserId) {
                this.textContent = 'Cannot ping yourself';
                this.style.background = '#f44336';
                setTimeout(() => {
                    this.textContent = 'Ping';
                    this.style.background = '#00c853';
                }, 2000);
                return;
            }
            
            postWithCSRF(`/ping/${playerId}`)
                .then(response => {
                    if (response.ok) {
                        this.textContent = 'Pinged!';
                        this.style.background = '#4caf50';
                        setTimeout(() => {
                            this.textContent = 'Ping';
                            this.style.background = '#00c853';
                        }, 2000);
                    } else {
                        // Handle different error codes
                        return response.json().then(data => {
                            this.textContent = data.error || 'Error';
                            this.style.background = '#f44336';
                            setTimeout(() => {
                                this.textContent = 'Ping';
                                this.style.background = '#00c853';
                            }, 2000);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.textContent = 'Failed';
                    this.style.background = '#f44336';
                    setTimeout(() => {
                        this.textContent = 'Ping';
                        this.style.background = '#00c853';
                    }, 2000);
                });
        });
    });

</script>

</body>
</html>